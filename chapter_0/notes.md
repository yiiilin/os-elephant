# 第零章

## 软件如何访问硬件

硬件适配设备即为IO接口，接口是一种标准，硬件按照该标准工作便实现了通用

硬件输入输出分为串行与并行，对应的接口也分串行和并行，串行硬件通过串行接口与CPU通信，反之亦然

访问外部硬件有两种方式：

1. 将外设的内存映射到某个地址范围，CPU访问该地址即为访问外设内存，如：显卡，显卡的显存被映射到主机屋里内存的低端1MB的0xB8000_0xBFFFF
2. 通过IO接口与CPU通信，即访问IO接口的寄存器

## 应用程序是什么

编译器将代码翻译为机器指令，编译器提供了库函数，库函数中有系统调用封装，这样的库也被称为运行库，机器指令会调用硬件资源完成任务

用户态与内核态是相对于CPU的概念，CPU运行在用户态（特权3级）还是内核态（特权0级）

用户进程陷入内核是指：内外部终端发生时，当前进程被终止执行，上下文被内核中断程序保存（保存至特权0级的栈中），并开始执行内核的代码

## 内存访问为什么要分段

段基址寄存器：

* cs （code section 代码段）
* ds （data section 数据段）
* es （？）
* ss （stack section 栈段）

16位寄存器(2^16=65536=64KB)如何访问1MB的内存（每个地址都能读入8位，即一个字节）

采用“段基址+段内偏移地址”访问，CPU自动将段基址左移4位，即乘以2^4，地址便为20位

## 代码段、数据段？程序如何执行的？

下一条命令的地址是上一条命令的地址加上上一条命令的尺寸得来的，程序计数器cs: eip，当前eip的地址加上当前指令机器码的大小就是下条指令的地址

数据段存在对齐，对齐的空隙会塞0

哪怕代码段中间夹杂了数据，依然可以通过jmp指令跳至下一个代码段

编译器将代码编译后放入连续的区域，即代码段，已经初始化的数据也放入连续的区域，即数据段，即编译器会将代码归类

CPU再保护模式下，提供了全局描述符表：GDT，每一项称为段描述符，段描述符有段的属性位（S字段，占1bit；TYPE字段，占4bit），**该表由操作系统填写**

1. 编译器负责挑选数据具备的类型，对代码进行归类
2. 操作系统通过设置GDT构建段描述符，给段设置属性
3. CPU的段寄存器被操作系统赋予选择子，确定了指向的段，执行命令时，会根据段的属性判断指令行为，若有返回则发出异常（？）

程序分段由编译器处理

readelf -e /bin/ls 可以查看ls段内容

内存分段是处理器为访问内存而采用的机制
